# 开发和部署项目

## 1. 简介

项目一般由模块组成, 它能够满足普通用户的直接使用需求，例如航班延误预测应用, 图片风格迁移应用, 兰花分类项目等。

## 2. 新建一个项目

在工作台中新建一个项目并进入开发页面，打开`coding_here.ipynb`或新建一个`notebook`。

## 3. 调用他人发布公开的模块

在 Mo 的 Notebook 中，我们可以轻松的在我们自己的代码中，插入别人已经编写好的模块 (Module)。
插入过程按以下步骤操作：

1. 首先选择想要插入模块代码的 Cell 
2. 打开左侧的模块图标， 搜索 `iris`, 选择 `iris_classifier`
3. 在右侧区域打开的 Tab 中， 浏览模块详情, 选择对应的版本
4. 点击`插入模块`按钮， 插入模块
5. 用 Notebook 界面顶上的运行按钮 <img src='http://imgbed.momodel.cn/5cc1a28ae3067ceb154f0e4f.jpg' width='30px'>， 或者 `Shift+Enter`， 即可运行插入的模块
   ![](https://imgbed.momodel.cn/mo/1030模块导入.png)

![](https://imgbed.momodel.cn/mo/1030模块插入中.png)

<!--<img src='https://imgbed.momodel.cn/插入模块3.gif' width=100% height=100%>-->

如果你得到了下图中的结果， 那么恭喜你， 成功用模块进行了一次预测
<img src='http://imgbed.momodel.cn/5cc1a28ae3067ceb154f0e4d.jpg' width='80%'>

## 4. 二次训练他人发布公开的模型模块

如果引入的模块是可以训练的，那么我们看看如何对引入的模型模块进行二次训练.

1. 选择想要插入模块代码的 Cell 
2. 先引入我们在本教程中需要使用到的数据集，前面的教程里我们已经学会了[如何使用数据集](https://momodel.cn/docs/#/zh-cn/%E5%A6%82%E4%BD%95%E5%AF%BC%E5%85%A5%E5%B9%B6%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97%E5%92%8C%E6%95%B0%E6%8D%AE%E9%9B%86),我们搜索并插入 star-face 这个数据集. 然后` !7zx ./datasets/luxu1220-star-face/star-face.zip `来解压这个数据集的压缩文件,我们得到一个新的文件夹名为 star-face

![](http://imgbed.momodel.cn/5cc1a28be3067ceb154f0e52.jpg)

3. 然后, 打开左侧的模块图标，搜索 `new_face_feature`, 选择 `new_face_feature`

4. 在右侧区域打开的 Tab 中， 浏览模块详情， 注意查看各个参数的说明

5. 在 Train 部分点击 插入代码 按钮， 插入此模块 (插入代码时, 会有一个上方会有一个“插入中”的提示框， 表示正在导入模型到项目中)

6. 更改训练模块的输入参数，定义 `conf={'model_save_path': 'my_model.h5', 'epochs': 2, 'log_dir': './', 'data_path': './star-face', 'weight_save_path': 'my_weight.h5'}`

7. 然后使用 shift+enter 快捷键或者点击上面的运行按钮运行刚才插入的几个cell

![](http://imgbed.momodel.cn/5cc1a28ae3067ceb154f0e50.jpg)

8. 训练完成后，在左侧可以看到模型和权重文件已经被保存下来了，然后我们就可以在预测部分使用它们了.

当然, 我们这里只是一个示例，模型没有很大， 训练的 epoch 也很小，效果提升不明显. 如果你使用的模型模块是基于深度神经网络的，并且网络结构很大，那么训练时间会比较长，这时候可以创建 job 并使用 GPU 来加速训练过程，详见[这里](https://momodel.cn/docs/#/zh-cn/%E5%9C%A8GPU%E6%88%96CPU%E8%B5%84%E6%BA%90%E4%B8%8A%E8%AE%AD%E7%BB%83%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A8%A1%E5%9E%8B)

## 5. 部署应用

我们的功能代码在 Notebook 调试完成后就可以点击左侧的部署图标，按照指引部署应用。

1. 开始部署

在 Notebook 中点击左侧栏中的部署图标，进入部署页面。

<img src='https://imgbed.momodel.cn/bushujiemein.png' width=40% height=40%>

2. 插入handle函数

handle函数是应用函数的的主函数，也是把输入和输出参数对应起来的接口函数，是部署之后其他人调用你的服务的处理方法。选中 Cell 代码的地方，点击第一步的“插入”按钮插入handle函数。然后根据前面调试的功能代码和定义的输入输出参数，整理 handle 函数。请按照该函数中的注释说明规范填写参数结构，这样系统就能自动提取输入输出参数，生成配置文件。

<img src='https://imgbed.momodel.cn/charuhandle.png' width=40% height=40%>

3. 准备部署文件

整理好 handle 函数之后，点击第二步的"开始"按钮，开始准备部署时需要的文件。
<img src='https://imgbed.momodel.cn/kaishibushu.png' width=40% height=40%>

以下为操作过程，首先选择需要部署的代码，handle 函数和新建 Notebook 生成的代码必须选择。然后预览生成的代码，如果有误可以点击上一步重新选择，接下来定义输入输出参数，这里定义四个输入参数，一个输出参数。最后生成 YML 配置文件，系统会根据之前定义的 handle 函数自动识别参数。通过这个步骤我们生成部署时需要的 Python 脚本和 YML 配置文件。
当然，你可以对生成的 `handler.py` 和 `app_spec.yml` 文件进行进一步的编辑。

<div key='1'>
<video src="https://imgbed.momodel.cn/mo/1030部署文件准备.mp4" controls="controls" width="100%" height="100%" />
</div>

<!--![](https://imgbed.momodel.cn/部署.gif)-->

4. 部署应用项目

完成所有以上步骤后，点击第3步的 `部署` 按钮进行项目部署。

<img src='https://imgbed.momodel.cn/bushu.png' width=40% height=40%>

在部署的时候，系统会自动生成 `handler.py` 文件和 `app_spec.yml`  配置文件，你可以选择需要发布的文件或勾选发布开发版本或正式版本（开发版本部署后只有所有者可以使用，正式版项目为公开的，所有人可见），然后点击“完成”，进行部署。
![](https://imgbed.momodel.cn/dainjibushu.png)

在短暂的等待后, 回到应用的详情页面, 在右上角会有部署成功的通知。恭喜你！你已经完成了你的第一个APP的部署。

## 6. 运行已部署的项目

然后可以在部署栏里点击`测试项目`，在网页中输入参数，运行得到输出结果，如果发现问题，可再回到项目中进行调试。

<img src='https://imgbed.momodel.cn/ceshixiangmu.png' width=40% height=40%>
